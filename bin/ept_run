#!/usr/bin/env python
# coding=utf-8
from multiprocessing import Pool
import asyncio
import importlib

import uvloop
from ept.util import csv_util, date_util


def _task(parallel_tasks, module_name, func, args, kwargs):
    module = importlib.import_module('ept.core.' + module_name)
    asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())
    loop = asyncio.get_event_loop()
    loop.run_until_complete(asyncio.gather(
        *[getattr(module, func)(args, kwargs)
          for _ in range(parallel_tasks)]
    ))
    loop.close()


def run(parallel_tasks, module_name, func, processes, for_loop,
        *args, **kwargs):
    with Pool(processes=int(processes)) as pool:
        results = [pool.apply_async(_task, (parallel_tasks, module_name, func,
                                            args, kwargs))
                   for _ in range(int(for_loop))]
        for r in results:
            r.wait()


if __name__ == '__main__':
    csv_util.remove('log.csv')
    csv_util.create('log.csv')
    start_time = date_util.timestamp_now()
    run(16, 'http', 'get', 2, 250, 'http://localhost:60001/get', 'test')
    print(date_util.timestamp_now() - start_time)
