#!/usr/bin/env python
# coding=utf-8
from multiprocessing import Pool
import asyncio
import importlib

import uvloop
from ept.core import csv_processor, date_util


def run(n, module_name, func, *args, **kwargs):
    module = importlib.import_module(module_name, '.')
    asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())
    loop = asyncio.get_event_loop()
    loop.run_until_complete(asyncio.gather(
        *[getattr(module, func)(*args, **kwargs) for _ in range(n)]
    ))
    loop.close()


if __name__ == '__main__':
    csv_processor.remove('log.csv')
    csv_processor.create('log.csv')
    start_time = date_util.timestamp_now()
    with Pool(processes=2) as pool:
        results = [pool.apply_async(
            run, (16, 'http', 'get', 'http://127.0.0.1:60001/get', 'test')) for _ in range(250)]
        for r in results:
            r.wait()
    print(date_util.timestamp_now() - start_time)
